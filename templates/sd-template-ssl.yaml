# Copyright Jiaqi Liu
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
namespace: QubitPi
name: jersey-webservice-release-definition-ssl
version: '1.0.0'
description: |
  Screwdriver CD template for deploying instantiated jersey webservice to AWS through HashiCorp.
  This template deploys the webservices with SSL/HTTPS support
maintainer: jack20220723@gmail.com
config:
  template: QubitPi/jersey-webservice-release-definition-basic
  order: [
    setup-jdk,
    install-maven,
    install-packer,
    install-terraform,
    checkout-hashicorp-deployment-tool,
    setup-packer,
    load-packer-variable-file,
    load-ssl-certificate,
    load-ssl-certificate-key,
    load-nginx-config-file-for-ssl,
    load-filebeat-config-file,
    load-terraform-variable-file,
    clone-webservice,
    load-properties-file,
    generate-war,
    relocate-war-for-hashicorp,
    packer-init,
    packer-validate,
    packer-build,
    terraform-init,
    terraform-validate,
    terraform-apply,
  ]
  steps:
    - load-ssl-certificate: echo "$SSL_CERTIFICATE" > ../hashicorp-aws/hashicorp/webservice/images/ssl.crt
    - load-ssl-certificate-key: echo "$SSL_CERTIFICATE_KEY" > ../hashicorp-aws/hashicorp/webservice/images/ssl.key
    - load-nginx-config-file-for-ssl: echo "$NGINX_CONFIG_FILE" > ../hashicorp-aws/hashicorp/webservice/images/nginx.conf
    - load-filebeat-config-file: echo "$FILEBEAT_CONFIG_FILE" > ../hashicorp-aws/hashicorp/webservice/images/filebeat.yml
  secrets:
    - SSL_CERTIFICATE
    - SSL_CERTIFICATE_KEY
    - NGINX_CONFIG_FILE
    - FILEBEAT_CONFIG_FILE
